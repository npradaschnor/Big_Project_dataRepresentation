<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" http-equiv="refresh" content="60" />
    <!--Auto refresh every 60 seconds-->
    <title>Patient Database</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <style>
        h1 {
            color: #170aa8;
            font-family: "Avenir", Comfortaa;
            font-size: 50px;
            font-weight: normal;
            text-align: center;
            text-shadow: 1px 1px 2px #070429;
        }
        
        body,
        h1 {
            letter-spacing: 3px
        }
        
        body {
            height: 900px;
            background-color: #ecf3f2;
            font-family: "Raleway", sans-serif;
        }
        
        a {
            color: #1977cc;
        }
        
        a:hover {
            color: #3291e6;
            text-decoration: none;
        }
        /* When moving the mouse over the submit button, add a color */
        
        input[type=submit]:hover {
            background-color: lightgrey;
        }
        /* When hovered bars change colour */
        
        .container {
            position: relative;
            width: 900px;
            clear: both;
        }
        
        .container input {
            width: 100%;
            clear: both;
        }
        
        #getStarted {}
        /* Button to create new patient */
        
        #showCreate-button {
            font-family: "Raleway", sans-serif;
            font-weight: 500;
            font-size: 20px;
            letter-spacing: 1px;
            display: inline-block;
            padding: 12px 35px;
            border-radius: 50px;
            transition: 0.5s;
            color: #fff;
            background: #1977cc;
        }
        
        #showCreate-button:hover {
            background: #063a68;
            text-decoration: none;
        }
        /* Button clicked after the new patient info was input */
        
        #create-button {}
        /* Form showed when the showCreate-button or update button is clicked */
        
        #createUpdateForm {}
        
        #patientTable {
            border-collapse: collapse;
            width: 100%;
        }
        
        #patientTable td,
        #patientTable th {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        #patientTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        #patientTable tr:hover {
            background-color: #ddd;
        }
        
        #patientTable th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #091e64;
            color: white;
        }
        
        #showUpdateButton {
            color: black;
            border: 2px solid #008CBA;
        }
        
        #showUpdateButton:hover {
            background-color: #008CBA;
            color: white;
        }
        
        #showUpdateButton {
            border-radius: 12px;
            transition: 0.5s;
        }
        
        #doDeleteButton {
            border-radius: 12px;
            transition: 0.5s;
        }
        
        #doDeleteButton:hover {
            background-color: #555555;
            color: white;
        }
    </style>
</head>

<body>
    <div id="getStarted">
        <h1>Patient Database</h1>

    </div>


    <!----------------- Create and Update Form ------------------------------------------>

    <div id="create-update" style="display:none">

        <h2><span id="createLabel">Create a</span> <span id="updateLabel">Update</span> Patient </h2>

        <table id="createUpdateForm">
            <tr>
                <td>Patient ID</td>
                <td><input type="text" name="id" id="idInput" placeholder="L1234A"></td>
            </tr>
            <tr>
                <td>First Name</td>
                <td><input type="text" name="firstName" placeholder="Joe"></td>
            </tr>
            <tr>
                <td>Last Name</td>
                <td><input type="text" name="lastName" placeholder="Duffy"></td>
            </tr>
            <tr>
                <td>Reason for Visiting</td>
                <td><input type="text" name="reasonForVisiting" placeholder="Medical Abbreviation"></td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <button id="create-button" onclick="doCreate()">Create</button>
                    <button id="update-button" onclick="doUpdate()">Update</button>
                </td>
            </tr>
        </table>
    </div>
    <div id="display">

        <!----------------- Patient Table ------------------------------------------>

        <button id="showCreate-button" onClick="showCreate()">Create</button>
        <table id="patientTable" class="table">
            <tr>
                <th>Patient ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Reason for Visiting</th>
                <th></th>
                <th></th>
            </tr>

        </table>

    </div>


</body>


<script>
    function showCreate() {
        document.getElementById('display').style.display = "none"
        document.getElementById('update-button').style.display = "none"
        document.getElementById('create-button').style.display = "block"
        document.getElementById('create-update').style.display = "block"

    }

    function showUpdate(thisElem) {
        var rowElement = thisElem.parentNode.parentNode;
        patient = readPatientFromRow(rowElement)
        populateForm(patient)

        document.getElementById('display').style.display = "none"
        document.getElementById('update-button').style.display = "block"
        document.getElementById('create-button').style.display = "none"
        document.getElementById('create-update').style.display = "block"
    }


    function readPatientFromRow(rowElement) {
        patient = {}
        patient.id = rowElement.getAttribute("id");
        patient.firstName = rowElement.cells[1].firstChild.textContent
        patient.lastName = rowElement.cells[2].firstChild.textContent
        patient.reasonForVisiting = rowElement.cells[3].firstChild.textContent

        return patient

    }

    function doCreate() {
        var form = document.getElementById('createUpdateForm')

        var patient = {}

        patient.id = form.querySelector('input[name="id"]').value
        patient.firstName = form.querySelector('input[name="firstName"]').value
        patient.lastName = form.querySelector('input[name="lastName"]').value
        patient.reasonForVisiting = form.querySelector('input[name="reasonForVisiting"]').value
        createPatientAjax(patient)


    }

    function populateForm(patient) {
        var form = document.getElementById('createUpdateForm')


        form.querySelector('input[name="id"]').value = patient.id
        form.querySelector('input[name="id"]').disabled = true

        form.querySelector('input[name="firstName"]').value = patient.firstName
        form.querySelector('input[name="lastName"]').value = patient.lastName
        form.querySelector('input[name="reasonForVisiting"]').value = patient.reasonForVisiting
    }

    function clearForm() {
        var form = document.getElementById('createUpdateForm')


        form.querySelector('input[name="id"]').value = ''
        form.querySelector('input[name="id"]').disabled = false

        form.querySelector('input[name="firstName"]').value = ''
        form.querySelector('input[name="lastName"]').value = ''
        form.querySelector('input[name="reasonForVisiting"]').value = ''
    }

    host = window.location.origin

    function createPatientAjax(patient) {
        console.log(JSON.stringify(patient));

        $.ajax({
            //"url": "http://127.0.0.1:5000/patients",
            "url": host + "/patients",
            "method": "POST",
            "data": JSON.stringify(patient),
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success": function(result) {
                //console.log(result);
                patient.id = result.id
                addPatientToTable(patient)
                showDisplay()
                clearForm()

            },
            "error": function(xhr, status, error) {
                console.log("error" + error)
            }
        })

    }

    function doUpdate() {
        patient = getPatientFromForm()
        updateServer(patient)

    }

    function updateServer(patient) {
        $.ajax({
            //"url": "/patients/" + patient.id,
            "url": host + "/patients/" + patient.id,
            "data": JSON.stringify(patient),
            "method": "PUT",
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success": function(result) {
                console.log(result)
                updateTableRow(patient)
                showDisplay()
                clearForm()

            },
            "error": function(xhr, status, error) {
                console.log("error" + error)
            }
        })
    }

    function doDelete(thisElem) {
        var tableElement = document.getElementById('patientTable');
        var rowElement = thisElem.parentNode.parentNode;
        var index = rowElement.rowIndex;
        id = rowElement.getAttribute("id");

        $.ajax({
            "url": host + "/patients/" + id,
            "method": "DELETE",
            "dateType": "JSON",
            "success": function(result) {
                tableElement.deleteRow(index);
            },
            "error": function(xhr, status, error) {
                console.log(error)
            }
        })

    }

    function updateTableRow(patient) {
        rowElement = document.getElementById(patient.id)
        rowElement.cells[1].firstChild.textContent = patient.firstName
        rowElement.cells[2].firstChild.textContent = patient.lastName
        rowElement.cells[3].firstChild.textContent = patient.reasonForVisiting
        console.log("updating table")
    }

    function getPatientFromForm() {
        var form = document.getElementById('createUpdateForm')

        var patient = {}
        patient.id = form.querySelector('input[name="id"]').value
        patient.firstName = form.querySelector('input[name="firstName"]').value
        patient.lastName = form.querySelector('input[name="lastName"]').value
        patient.reasonForVisiting = form.querySelector('input[name="reasonForVisiting"]').value
            //console.log(patient)
        return patient
    }

    function showDisplay() {
        document.getElementById('display').style.display = "block"
        document.getElementById('create-update').style.display = "none"

    }

    function populateTable() {
        //ajax getAll

        $.ajax({
            //"url": 'http://127.0.0.1:5000/patients',
            "url": host + '/patients',
            "method": 'GET',
            "datatype": 'JSON',
            "success": function(results) {
                for (patient of results) {
                    addPatientToTable(patient)
                }
            },
            "error": function(xhr, status, error) {
                console.log("error " + error + " code:" + status)
            }

        })

    }

    function addPatientToTable(patient) {
        console.log("Adding Patient to Table")

        var tableElem = document.getElementById("patientTable")
        var rowElem = tableElem.insertRow(-1)
        rowElem.setAttribute("id", patient.id)
        var cell1 = rowElem.insertCell(0)
        cell1.innerHTML = patient.id
        var cell2 = rowElem.insertCell(1)
        cell2.innerHTML = patient.firstName
        var cell3 = rowElem.insertCell(2)
        cell3.innerHTML = patient.lastName
        var cell4 = rowElem.insertCell(3)
        cell4.innerHTML = patient.reasonForVisiting
        var cell5 = rowElem.insertCell(4)
        cell5.innerHTML = '<button onclick="showUpdate(this)">Update</button>'
        var cell6 = rowElem.insertCell(5)
        cell6.innerHTML = '<button onclick="doDelete(this)">Delete</button>'
    }
    populateTable()
</script>


</html>